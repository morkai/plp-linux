// Part of <https://miracle.systems/p/walkner-snf> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/viewport","../views/ActionFormView","app/core/templates/jumpAction","app/core/templates/exportAction"],function(e,t,r,n,a,o,i){"use strict";function l(e,t,r){return!1===t?null:t||e.getPrivilegePrefix()+":"+(r||"MANAGE")}function u(e){return e.paginationData?e.paginationData.get("totalCount"):e.length}function c(t,r,a,o){var i=a[0].phrase;if(i.readOnly)return!1;var l=i.value;i.readOnly=!0;var u=a.find(".fa").removeClass("fa-search").addClass("fa-spinner fa-spin"),c=t.ajax("rid"===o.mode?{url:e.result(r,"url")+";rid",data:{rid:l}}:{method:"HEAD",url:e.result(r,"url")+"/"+l});return c.done(function(e){t.broker.publish("router.navigate",{url:r.genClientUrl()+"/"+(e||l),trigger:!0})}),c.fail(function(){n.msg.show({type:"error",time:2e3,text:s(r,"MSG:jump:404",{rid:l})}),u.removeClass("fa-spinner fa-spin").addClass("fa-search"),i.readOnly=!1,i.select()}),!1}function p(e){var a=n.msg.show({type:"warning",text:r("core","MSG:EXPORTING"),sticky:!0}),o=t.ajax({url:e});return o.fail(function(){n.msg.show({type:"error",time:2500,text:r("core","MSG:EXPORTING_FAILURE")})}),o.done(function(e){window.open("/express/exports/"+e)}),o.always(function(){n.msg.hide(a)}),!1}function s(e,t,n){var a=e.getNlsDomain();return r.bound(r.has(a,t)?a:"core",t,n)}return{add:function(e,t){return{label:s(e,"PAGE_ACTION:add"),icon:"plus",href:e.genClientUrl("add"),privileges:l(e,t)}},edit:function(e,t){return{label:s(e,"PAGE_ACTION:edit"),icon:"edit",href:e.genClientUrl("edit"),privileges:l(e,t)}},delete:function(t,r,n){return n||(n={}),{label:s(t,"PAGE_ACTION:delete"),icon:"times",href:t.genClientUrl("delete"),privileges:l(t,r),callback:function(r){r&&0!==r.button||(r&&r.preventDefault(),a.showDeleteDialog(e.defaults({model:t},n)))}}},export:function(t,r,n,a){function o(e){var t=e.find('a[data-export-type="xlsx"]');if(t.length){var r=t.prop("href");t.prop("href","javascript:void(0)"),t.on("click",function(e){e.preventDefault(),p(r)})}}var c={layout:t,page:r,collection:n,privilege:a,maxCount:6e4};1===arguments.length&&e.assign(c,t);var f=function(){var t=u(c.collection),r=e.result(c.collection,"url")+";export.${format}?"+c.collection.rqlQuery,n=[{type:"csv",href:r.replace("${format}","csv")}];return window.XLSX_EXPORT&&t<c.maxCount/2&&n.push({type:"xlsx",href:r.replace("${format}","xlsx")}),i({type:t>=c.maxCount/2?"danger":t>=c.maxCount/4?"warning":"default",formats:n,disabled:t>=c.maxCount||0===t,label:c.label||s(c.collection,"PAGE_ACTION:export")})};return c.page.listenTo(c.collection,"sync",function(){c.layout.$(".page-actions-export").replaceWith(f()),o(c.layout.$(".page-actions-export"))}),{template:f,privileges:l(c.collection,c.privilege,"VIEW"),callback:c.callback,afterRender:o}},exportXlsx:p,jump:function(t,r,n){return n=e.assign({mode:"rid",pattern:"^ *[0-9]+ *$",autoFocus:!window.IS_MOBILE},n),{template:function(){return o({title:n.title||s(r,"PAGE_ACTION:jump:title"),placeholder:n.placeholder||s(r,"PAGE_ACTION:jump:placeholder"),autoFocus:n.autoFocus,pattern:n.pattern})},afterRender:function(e){var a=e.find("form");a.submit(c.bind(null,t,r,a,n))}}}}});