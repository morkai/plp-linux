define(["underscore","jquery","app/broker","app/pubsub","app/user","app/tags/TagCollection"],function(e,n,a,t,o,l){"use strict";var i=[],r={};function s(){if(!r.loading){var a=n.ajax({url:e.result(r.tags,"url")}).done(function(e){u(e.collection)});return r.loading=n.when(a),r.loading.done(function(){r.loaded=!0}),r.loading.always(function(){r.loading=null}),r.loading}}function u(n){var t={},o={silent:!0};0===r.tags.length||Object.keys(n).length!==r.tags.length?(r.tags.reset(n,o),e.forEach(n,function(e){t[e.name]=e.value})):e.forEach(n,function(e){var n,a=r.tags.get(e.name);a?(n=a.get("value"),a.set(e,o)):r.tags.add(e,o),e.value!==n&&(t[e.name]=e.value)}),e.forEach(i,function(n){var a=n.time;e.forEach(i.newValues,function(e,n){var l=r.tags.get(n);l&&a>l.get("lastChangeTime")&&(l.set({lastChangeTime:a,value:e},o),t[n]=e)})}),i=[],r.tags.trigger("reset"),e.isEmpty(t)||a.publish("controller.valuesChanged",t)}return r.auth={isEmbedded:function(){return"localhost"===window.location.hostname||window!==window.parent&&-1!==window.navigator.userAgent.indexOf("X11; Linux")}},r.tags=new l([],{paginate:!1}),r.loaded=!1,r.loading=null,r.load=function(){return r.loaded?n.Deferred().resolve().promise():r.loading?r.loading:s()},a.subscribe("socket.connected",function(){s()}),t.subscribe("controller.tagsChanged",function(e){u(e)}),t.subscribe("controller.tagValuesChanged",function(n){if(r.loading)i.push({time:n["@timestamp"],newValues:n});else{var t={};e.forEach(n,function(n,a){var o=r.tags.get(a);o&&!e.isEqual(n,o.get("value"))&&(o.set("value",n),t[a]=n)}),e.isEmpty(t)||a.publish("controller.valuesChanged",t)}}),window.controller=r,r});