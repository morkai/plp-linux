define(["form2js","app/time","app/viewport","app/user","app/controller","app/core/View","app/horti-dashboard/templates/program","app/horti-dashboard/templates/programStep"],function(t,e,r,o,a,s,i,n){"use strict";return s.extend({template:i,nlsDomain:"horti-dashboard",events:{"click #-addProgramStep":function(){this.addProgramStep({on:0,off:0,repeat:1})},"focus input":function(){this.scheduleBlur()},"keyup input":function(){this.scheduleBlur()},submit:function(t){t.preventDefault();const e=this.serializeProgram();if(!e.steps.length)return r.msg.show({type:"warning",time:3e3,text:this.t("msg:invalidProgram")});this.$(".form-actions").find(".btn").prop("disabled",!0),a.tags.setValue("program",e,t=>{this.$(".form-actions").find(".btn").prop("disabled",!1),t?(console.error("Failed to save program:",{program:e},t),r.msg.show({type:"error",time:3e3,text:this.t("msg:saveProgramFailure")})):r.closeDialog()})}},initialize:function(){this.stepI=0,this.listenTo(a.tags.get("program"),"change:value",()=>this.renderProgram())},afterRender:function(){this.renderProgram(),o.isAllowedTo("LOCAL","HORTI:MANAGE")||(this.$(".form-control, .btn").prop("disabled",!0),this.$(".cancel").prop("disabled",!1))},scheduleBlur:function(){clearTimeout(this.timers.blur),this.timers.blur=setTimeout(()=>document.activeElement.blur(),1e4)},renderProgram:function(t){this.$id("programSteps").html(""),t=t||a.tags.getValue("program")||{name:"",steps:[]},this.$id("programName").val(t.name),t.steps.forEach(t=>{this.addProgramStep(t)}),t.steps.length||this.addProgramStep({on:0,off:0,repeat:1})},addProgramStep:function(t){const r=this.$id("programSteps"),o=e.toString(t.on,!0,!1).split(":").map(t=>t.replace(/^0+/,"")),a=e.toString(t.off,!0,!1).split(":").map(t=>t.replace(/^0+/,""));r.append(this.renderPartialHtml(n,{i:this.stepI++,no:r[0].childElementCount+1,step:{on:{h:o[0],m:o[1],s:o[2]},off:{h:a[0],m:a[1],s:a[2]},repeat:t.repeat}}))},serializeProgram:function(){const e={name:this.$id("programName").val().trim(),steps:[]},r=t(this.el);return r.program&&Array.isArray(r.program.steps)&&r.program.steps.forEach(t=>{t.on||(t.on={}),t.off||(t.off={});const r={on:3600*(+t.on.h||0)+60*(+t.on.m||0)+(+t.on.s||0),off:3600*(+t.off.h||0)+60*(+t.off.m||0)+(+t.off.s||0),repeat:+t.repeat};r.repeat>0&&(r.on>0||r.off>0)&&e.steps.push(r)}),e}})});