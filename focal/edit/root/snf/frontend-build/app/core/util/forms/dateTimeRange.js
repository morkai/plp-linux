// Part of <https://miracle.systems/p/walkner-snf> licensed under <CC BY-NC-SA 4.0>

define(["underscore","jquery","app/i18n","app/time","app/core/util/getShiftStartInfo","app/core/templates/forms/dateTimeRange"],function(t,e,a,r,n,s){"use strict";function i(){c||(e(document).on("click",".dateTimeRange-is-input > .dropdown-toggle",o),c=!0)}function o(t){var a=t.currentTarget,r=document.getElementById(a.htmlFor);r&&requestAnimationFrame(function(){r.disabled||e(r).prop("checked",!0).trigger("change")})}function l(t){return Array.isArray(t.dropdown)?t.dropdown.map(function(t){return"object"==typeof t.attrs&&(t.attrs=Object.keys(t.attrs).map(function(e){return e+'="'+t.attrs[e]+'"'}).join(" ")),t}):null}function u(e){if(!0===e.ranges&&(e.ranges=""),"string"!=typeof e.ranges)return null;var a={shifts:!1,days:!0,weeks:!0,months:!0,quarters:!0,years:!0};e.ranges.split(" ").some(function(t){return/^[^+\-]/.test(t)})&&Object.keys(a).forEach(function(t){a[t]=!1});var r=t.assign({},h);return e.ranges.split(" ").forEach(function(t){var e="-"===t.charAt(0)?"-":"+",n=t.replace(/^[^a-z]+/,"").split(":"),s=n.shift(),i=n.length?n[0].split("_"):[];a[s]="+"===e,i.length&&(r[s]=i)}),Object.keys(a).forEach(function(t){if(!r[t]||!a[t])return void delete a[t];a[t]=r[t]}),a}function m(t,e){var a=36e5;if(t<=8*a)return"hour";var r=24*a;if(t<=9e7)return"shift";if("weeks"===e&&t>11988e5&&t<=243e7)return"week";var n=31*r;return t<=26892e5?"day":t<2.5*n?"week":t>12*n?"year":"month"}function d(t){i();var e=t.type||"date",n={idPrefix:t.idPrefix||"v",property:t.property||"date",formGroup:!1!==t.formGroup,hidden:!0===t.hidden,utc:t.utc?1:0,setTime:!1!==t.setTime?1:0,type:e,startHour:t.startHour||0,shiftLength:t.shiftLength||8,minDate:t.minDate||window.PRODUCTION_DATA_START_DATE||"",maxDate:""===t.maxDate?"":t.maxDate||r.getMoment().add(1,"years").format(f[e]),labels:[],separator:t.separator||"â€“",required:{date:!1,time:!1}};if(t.required){var o=n.required;"boolean"==typeof t.required?(o.date=!0,o.time=!0):(o.date=!!t.required.date,o.time=!!t.required.time)}return t.labels?Array.isArray(t.labels)?n.labels=[].concat(t.labels):n.labels.push(t.labels):n.labels.push({ranges:!0}),n.labels=n.labels.map(function(t){return{text:t.text||a("core","dateTimeRange:label:"+n.type),dropdown:l(t),input:t.input||null,ranges:u(t)}}),s(n)}var f={date:"YYYY-MM-DD",month:"YYYY-MM","date+time":"YYYY-MM-DD",time:"HH:mm:ss"},h={shifts:["+0+1","-1+0","1","2","3"],days:["+0+1","-1+0","-7+0","-14+0","-28+0"],weeks:["+0+1","-1+0","-2+0","-3+0","-4+0"],months:["+0+1","-1+0","-2+0","-3+0","-6+0"],quarters:["+0+1","1","2","3","4",null],years:["+0+1","-1+0",null,null,null]},c=!1;return d.handleRangeEvent=function(t){var e=this,a=e.$(t.target).closest("a[data-date-time-range]"),r=a.closest(".dateTimeRange"),s=r[0].dataset.type,i="1"===r[0].dataset.utc,o=+r[0].dataset.startHour,l=+r[0].dataset.shiftLength,u=a[0].dataset.dateTimeGroup,d=a[0].dataset.dateTimeRange,h=u,c=1,p=n(Date.now(),{utc:i,startHour:o,shiftLength:l}),g=p.moment,v=null;if(g.hours()<o&&g.subtract(24,"hours"),"shifts"===u?(h="hours",c=l):g.startOf("day"),/^[0-9]+$/.test(d))"shifts"===u?(g.subtract((p.no-1)*p.length,"hours").add((+d-1)*p.length,"hours"),v=g.clone().add(p.length,"hours")):("0"===d?g.startOf(h):g.startOf("year").add(d-1,h),v=g.clone().add(1,h));else{var y=d.match(/^([+-])([0-9]+)([+-])([0-9]+)$/)||[0,"+","0","+","1"];v=g.startOf(h).clone()["+"===y[3]?"add":"subtract"](+y[4]*c,h),g=g["+"===y[1]?"add":"subtract"](+y[2]*c,h)}"shifts"!==u&&(g.hours(o),v.hours(o));var b=f[s];r.find('input[name="from-date"]').val(g.format(b)),r.find('input[name="from-time"]').val(g.format("HH:mm:ss")),r.find('input[name="to-date"]').val(v.format(b)),r.find('input[name="to-time"]').val(v.format("HH:mm:ss"));var H=e.$('[name="interval"]');if(H.length){var Y={},T=[];H.each(function(){this.disabled||this.parentNode.classList.contains("disabled")||(Y[this.value]=this,T.push(this.value))});var D=m(v.valueOf()-g.valueOf(),u);Y[D]||(D=T[T.length-1]),D&&H.filter('[value="'+D+'"]').parent().click()}t.altKey&&e.$('[type="submit"]').click()},d.serialize=function(t){function e(t){return!t.isValid()||"time"!==n&&1970===t.year()}var a=t.$(".dateTimeRange"),n=a[0].dataset.type,s=f[n],i="1"===a[0].dataset.utc,o="1"===a[0].dataset.setTime,l=a[0].dataset.startHour,u=a.find('input[name="from-date"]'),m=a.find('input[name="from-time"]'),d=a.find('input[name="to-date"]'),h=a.find('input[name="to-time"]'),c=u.val(),p=m.val(),g=d.val(),v=h.val();(!u.length||c.length<7)&&(c="1970-01-01"),(!d.length||g.length<7)&&(g="1970-01-01"),7===c.length&&(c+="-01"),7===g.length&&(g+="-01");var y=o?(1===l.length?"0":"")+l+":00":"00:00:00";(!m.length||p.length<5)&&(p=y),(!h.length||v.length<5)&&(v=y),5===p.length&&(p+=":00"),5===v.length&&(v+=":00");var b=(i?r.utc:r).getMoment(c+" "+p,"YYYY-MM-DD HH:mm:ss"),H=(i?r.utc:r).getMoment(g+" "+v,"YYYY-MM-DD HH:mm:ss");return e(b)?(u.val(""),m.val(""),b=null):(u.val(b.format(s)),m.val(b.format("HH:mm:ss"))),e(H)?(d.val(""),h.val(""),H=null):(d.val(H.format(s)),h.val(H.format("HH:mm:ss"))),{property:a[0].dataset.property,from:b,to:H}},d.formToRql=function(t,e){var a=d.serialize(t);a.from&&e.push({name:"ge",args:[a.property,a.from.valueOf()]}),a.to&&e.push({name:"lt",args:[a.property,a.to.valueOf()]})},d.rqlToForm=function(t,e,a){var n,s=this,i=s.$(".dateTimeRange")[0].dataset,o=f[i.type],l="1"===i.utc,u=(l?r.utc:r).getMoment(e.args[1]);"ge"===e.name||"gt"===e.name?n="from":"le"!==e.name&&"lt"!==e.name||(n="to"),n&&u.isValid()&&(a[n+"-date"]=u.format(o),a[n+"-time"]=u.format("HH:mm:ss"))},d});