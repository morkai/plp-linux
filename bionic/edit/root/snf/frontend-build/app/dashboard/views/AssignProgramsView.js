// Part of <https://miracle.systems/p/walkner-snf> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/controller","app/viewport","app/core/View","app/snf-programs/Program","app/snf-programs/ProgramCollection","app/dashboard/templates/assign"],function(a,r,t,e,o,n,i,s){"use strict";return o.extend({template:s,events:{submit:"onSubmit"},afterRender:function(){this.loadPrograms()},loadPrograms:function(){e.msg.loading();var r=this,t=r.$id("submit"),o=new i(null,{rqlQuery:"select(_id,name,kind)&limit(0)"}),n=o.fetch();n.fail(function(){e.msg.loadingFailed()}),n.done(function(){var n={"30s":[],hrs:[],tester:[]};o.forEach(function(a){n[a.get("kind")].push({id:a.id,text:a.get("name")})}),a.forEach(n,function(a,t){a.sort(function(a,r){return a.text.localeCompare(r.name,void 0,{numeric:!0,ignorePunctuation:!0})}),r.$id(t).removeClass("form-control").prop("disabled",!1).val(r.getProgramId(t)).select2({allowClear:!0,placeholder:" ",data:a})}),e.msg.loaded(),t.prop("disabled",!1)})},onDialogShown:function(){this.closeDialog=e.closeDialog.bind(e)},onSubmit:function(r){function t(r){s=s||r,3===++i&&(n.attr("disabled",!1),s?e.msg.savingFailed():e.msg.saved(),!s&&a.isFunction(o.closeDialog)&&o.closeDialog())}r.preventDefault(),e.msg.saving();var o=this,n=o.$id("submit").attr("disabled",!0),i=0,s=null;o.setProgramTag("30s",o.$id("30s").val(),t),o.setProgramTag("hrs",o.$id("hrs").val(),t),o.setProgramTag("tester",o.$id("tester").val(),t)},getProgramId:function(a){var r=t.tags.getValue("program."+a);return r&&r._id?r._id:""},setProgramTag:function(a,r,t){if(r===this.getProgramId(a))return t();r?this.assignProgram(a,r,t):this.unassignProgram(a,t)},assignProgram:function(a,r,e){var o=new n({_id:r}),i=o.fetch();i.fail(function(){e(new Error("Failed to fetch program."))}),i.done(function(){t.tags.setValue("program."+a,o.toJSON(),e)})},unassignProgram:function(a,r){t.tags.setValue("program."+a,null,r)}})});