define(["underscore","app/ZeroClipboard","app/i18n","app/core/views/FormView","app/data/privileges","app/users/templates/form"],function(e,i,t,s,r,o){"use strict";return s.extend({template:o,events:{submit:"submitForm",'input input[type="password"]':function(e){null!==this.timers.validatePasswords&&clearTimeout(this.timers.validatePasswords),this.timers.validatePasswords=setTimeout(this.validatePasswords.bind(this,e),100)}},initialize:function(){s.prototype.initialize.call(this)},destroy:function(){this.privilegesCopyClient&&this.privilegesCopyClient.destroy()},afterRender:function(){s.prototype.afterRender.call(this),this.options.editMode||this.$('input[type="password"]').attr("required",!0),this.setUpPrivilegesControls()},setUpPrivilegesControls:function(){var e={},s=[];r.forEach(function(i){var r=t("users","PRIVILEGE:"+i);e[r]=i,s.push({id:i,text:r})});var o=this.$id("privileges").select2({width:"100%",allowClear:!1,tags:s,tokenSeparators:[";"],createSearchChoice:function(i){var t=i.trim(),s=e[t];return s?{id:s,text:t}:null}});this.privilegesCopyClient=new i(this.$id("copyPrivileges")),this.privilegesCopyClient.on("load",function(e){e.on("datarequested",function(e){var i=o.select2("data");0===i.length?e.setText(""):e.setText(i.map(function(e){return e.text}).join(";")+";")})}),this.privilegesCopyClient.on("wrongflash noflash",function(){i.destroy()})},validatePasswords:function(){var e=this.$id("password"),i=this.$id("password2");e.val()===i.val()?i[0].setCustomValidity(""):i[0].setCustomValidity(t("users","FORM:ERROR:passwordMismatch")),this.timers.validatePassword=null},serialize:function(){return e.extend(s.prototype.serialize.call(this),{privileges:r})},serializeToForm:function(){var e=this.model.toJSON();return e.privileges=e.privileges.join(","),e},serializeForm:function(i){return"string"==typeof(i=e.defaults(i,{privileges:[]})).privileges&&(i.privileges=i.privileges.split(",")),i}})});