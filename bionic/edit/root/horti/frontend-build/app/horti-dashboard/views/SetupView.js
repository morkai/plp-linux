define(["form2js","app/time","app/viewport","app/user","app/controller","app/core/View","app/horti-dashboard/templates/setup","app/horti-dashboard/templates/setupSn","app/horti-dashboard/templates/programStep"],function(e,t,s,r,i,o,a,n,m){"use strict";return o.extend({template:a,nlsDomain:"horti-dashboard",events:{"click #-start":function(){this.start(!1)},"click #-reset":function(){this.reset(!1)},'click .btn[data-action="removeSn"]':function(e){this.$id("serialNumbers").find(".btn").prop("disabled",!0);const{zoneNo:t}=this.options,s=this.$(e.target).closest(".horti-setup-serialNumber").find(".form-control").val(),r=(i.tags.getValue(`zones.${t}.serialNumbers`)||[]).filter(e=>e!==s);i.tags.setValue(`zones.${t}.serialNumbers`,r,e=>{e&&console.error(`Failed to remove serial number ${s}: ${e.message}`),this.$id("serialNumbers").find(".btn").prop("disabled",!1)})},"focus input":function(){this.scheduleBlur()},"keyup input":function(){this.scheduleBlur()},"click #-addProgramStep":function(){this.addProgramStep({on:0,off:0,repeat:1})},"click #-saveProgram":function(){const{zoneNo:e}=this.options,t=this.serializeProgram();if(!t.steps.length)return s.msg.show({type:"warning",time:3e3,text:this.t("msg:invalidProgram")});this.$id("saveProgram").prop("disabled",!0),this.$(".form-actions").find(".btn").prop("disabled",!0),i.tags.setValue(`zones.${e}.program`,t,e=>{this.$id("saveProgram").prop("disabled",!1),this.$(".form-actions").find(".btn").prop("disabled",!1),e?(console.error("Failed to save program:",{program:t},e),s.msg.show({type:"error",time:3e3,text:this.t("msg:saveProgramFailure")})):this.renderProgram(t)})}},initialize:function(){const{zoneNo:e}=this.options;this.stepI=0,this.listenTo(i.tags.get(`zones.${e}.status`),"change:value",this.onStatusChanged),this.listenTo(i.tags.get(`zones.${e}.serialNumbers`),"change:value",this.renderSerialNumbers)},getTemplateData:function(){return{zoneNo:this.options.zoneNo}},afterRender:function(){this.renderSerialNumbers(),this.renderProgram()},scheduleBlur:function(){clearTimeout(this.timers.blur),this.timers.blur=setTimeout(()=>document.activeElement.blur(),1e4)},renderSerialNumbers:function(){let e="";(i.tags.getValue(`zones.${this.options.zoneNo}.serialNumbers`)||[]).forEach(t=>{e+=this.renderPartialHtml(n,{sn:t})}),e||(e=`<p class="form-control-static">${this.t("setup:serialNumbers:empty")}</p>`),this.$id("serialNumbers").html(e),s.adjustDialogBackdrop()},renderProgram:function(e){this.$id("programSteps").html(""),e=e||i.tags.getValue(`zones.${this.options.zoneNo}.program`)||i.tags.getValue("program")||{name:"",steps:[]},this.$id("programName").val(e.name),e.steps.forEach(e=>{this.addProgramStep(e)}),e.steps.length||this.addProgramStep({on:0,off:0,repeat:1})},addProgramStep:function(e){const s=this.$id("programSteps"),r=t.toString(e.on,!0,!1).split(":").map(e=>e.replace(/^0+/,"")),i=t.toString(e.off,!0,!1).split(":").map(e=>e.replace(/^0+/,""));s.append(this.renderPartialHtml(m,{i:this.stepI++,no:s[0].childElementCount+1,step:{on:{h:r[0],m:r[1],s:r[2]},off:{h:i[0],m:i[1],s:i[2]},repeat:e.repeat}}))},onStatusChanged:function(){"setup"!==i.tags.getValue(`zones.${this.options.zoneNo}.status`)&&s.closeDialog()},start:function(e){if(this.$id("start").prop("disabled"))return;const{zoneNo:t}=this.options;if(!(i.tags.getValue(`zones.${t}.serialNumbers`)||[]).length)return e?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:snRequired")}):s.msg.show({type:"error",time:3e3,text:this.t("msg:snRequired")});const r=this.serializeProgram();if(!r.steps.length)return e?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:invalidProgram")}):s.msg.show({type:"error",time:3e3,text:this.t("msg:invalidProgram")});this.$(".form-actions").find(".btn").prop("disabled",!0),i.tags.setValue(`zones.${t}.program`,r,r=>{r&&(e?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:saveProgramFailure")}):s.msg.show({type:"error",time:3e3,text:this.t("msg:saveProgramFailure")})),i.tags.setValue(`zones.${t}.status`,"running",r=>{r?(this.$(".form-actions").find(".btn").prop("disabled",!1),e?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:startFailure",{zoneNo:t})}):s.msg.show({type:"error",time:3e3,text:this.t("msg:startFailure",{zoneNo:t})})):e&&this.broker.publish("horti.message",{type:"success",time:3e3,text:this.t("msg:startSuccess",{zoneNo:t})})})})},reset:function(e){if(this.$id("reset").prop("disabled"))return;const{zoneNo:t}=this.options;this.$(".form-actions").find(".btn").prop("disabled",!0),i.tags.setValue(`zones.${t}.status`,"idle",r=>{r?(this.$(".form-actions").find(".btn").prop("disabled",!1),e?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:resetFailure",{zoneNo:t})}):s.msg.show({type:"error",time:3e3,text:this.t("msg:resetFailure",{zoneNo:t})})):e&&this.broker.publish("horti.message",{type:"success",time:3e3,text:this.t("msg:resetSuccess",{zoneNo:t})})})},handleAction:function(e){"MAIN"===e||"START"===e?this.start(!0):"RESET"===e?this.reset(!0):this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:invalidAction",{action:e})})},handleSerialNumber:function(e){const{zoneNo:t}=this.options,s=i.tags.getValue(`zones.${t}.serialNumbers`)||[];let r;s.includes(e)?(r=s.filter(t=>t!==e),this.broker.publish("horti.message",{type:"warning",time:3e3,text:this.t("msg:snRemoved",{sn:e})})):(r=s.concat(e),this.broker.publish("horti.message",{type:"success",time:3e3,text:this.t("msg:snAdded",{sn:e})})),i.tags.setValue(`zones.${t}.serialNumbers`,r)},serializeProgram:function(){const t={name:this.$id("programName").val().trim(),steps:[]},s=e(this.el);return s.program&&Array.isArray(s.program.steps)&&s.program.steps.forEach(e=>{e.on||(e.on={}),e.off||(e.off={});const s={on:3600*(+e.on.h||0)+60*(+e.on.m||0)+(+e.on.s||0),off:3600*(+e.off.h||0)+60*(+e.off.m||0)+(+e.off.s||0),repeat:+e.repeat};s.repeat>0&&(s.on>0||s.off>0)&&t.steps.push(s)}),t}})});