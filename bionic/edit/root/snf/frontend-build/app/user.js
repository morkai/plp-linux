// Part of <https://miracle.systems/p/walkner-snf> licensed under <CC BY-NC-SA 4.0>

define(["underscore","app/i18n","app/broker","app/socket"],function(e,a,n,r){"use strict";var t=document.body.classList.contains("is-embedded"),i=[],o=0,l={};r.on("user.reload",function(e){l.reload(e)}),r.on("user.deleted",function(){window.location.reload()});var d=e.assign(window.GUEST_USER||{},{name:a.bound("core","GUEST_USER_NAME")});return delete window.GUEST_USER,l.data=d,l.lang=window.APP_LOCALE||window.appLocale||"pl",l.noReload=!1,l.isReloadLocked=function(){return i.length>0},l.lockReload=function(){return i.push(++o)},l.unlockReload=function(e){i=i.filter(function(a){return a!==e})},l.reload=function(r){if(t&&e.assign(r,{loggedIn:!1,super:!1,privileges:d.privileges,login:d.login,name:d.name}),!e.isEqual(r,l.data)){var i=l.isLoggedIn();e.isObject(r)&&Object.keys(r).length>0&&(!1===r.loggedIn&&(r.name=a.bound("core","GUEST_USER_NAME")),"unspecified"===r.orgUnitType&&(r.orgUnitType=null,r.orgUnitId=null),l.data=r),l.data.privilegesMap=null,l.noReload?l.noReload=!1:n.publish("user.reloaded"),i&&!l.isLoggedIn()?n.publish("user.loggedOut"):!i&&l.isLoggedIn()&&n.publish("user.loggedIn")}},l.isLoggedIn=function(){return!0===l.data.loggedIn},l.getLabel=function(e){return l.data.name?String(l.data.name):l.data.lastName&&l.data.firstName?l.data.lastName===l.data.firstName?l.data.lastName:e?l.data.firstName+" "+l.data.lastName:l.data.lastName+" "+l.data.firstName:l.data.login},l.getInfo=function(){return{id:l.data._id,ip:l.data.ip||l.data.ipAddress||"0.0.0.0",cname:window.COMPUTERNAME,label:l.getLabel()}},l.isAllowedTo=function(e){if(!1===l.data.active)return!1;if(l.data.super)return!0;var a=l.data.privileges,n=Array.prototype.slice.call(arguments),r=(1===n.length?[e]:n).map(function(e){return Array.isArray(e)?e:[e]});if(r.length&&l.data.local&&r[0].some(function(e){return"LOCAL"===e}))return!0;if(!a)return!1;var t=l.isLoggedIn();if(!r.length)return t;for(var i=0,o=r.length;i<o;++i){for(var d=r[i],s=0,u=d.length,g=0;g<u;++g){var p=d[g];"string"==typeof p?"USER"===p?s+=t?1:0:/^FN:/.test(p)?s+=l.data.prodFunction===p.substring(3)?1:0:s+=l.hasPrivilege(d[g])?1:0:u-=1}if(s===u)return!0}return!1},l.auth=function(){var e=Array.prototype.slice.call(arguments);return function(a,n,r){l.isAllowedTo.apply(l,e)?r():l.isLoggedIn()?require(["app/viewport","app/core/pages/ErrorPage"],function(e,r){e.showPage(new r({model:{code:403,req:a,previousUrl:n}}))}):require(["app/viewport","app/users/pages/LogInFormPage"],function(e,a){e.showPage(new a)})}},l.hasPrivilege=function(a){return l.data.privilegesMap||(Array.isArray(l.data.privileges)||(l.data.privileges=[]),l.data.privilegesString="|"+l.data.privileges.join("|"),l.data.privilegesMap={},e.forEach(l.data.privileges,function(e){l.data.privilegesMap[e]=!0})),"*"===a.charAt(a.length-1)?-1!==l.data.privilegesString.indexOf("|"+a.substr(0,a.length-1)):!0===l.data.privilegesMap[a]},l.getGuestUserData=function(){return window.GUEST_USER||{id:null,login:"guest",name:a.bound("core","GUEST_USER_NAME"),loggedIn:!1,super:!1,privileges:[]}},l.getRootUserData=function(){return window.ROOT_USER||{id:null,login:"root",name:"root",loggedIn:!0,super:!0,privileges:[]}},l.can={commentOrders:function(){return l.isAllowedTo("ORDERS:MANAGE","ORDERS:COMMENT","PLANNING:PLANNER","PLANNING:WHMAN","PAINT_SHOP:PAINTER","WH:VIEW","FN:master","FN:leader")}},window.user=l,l});