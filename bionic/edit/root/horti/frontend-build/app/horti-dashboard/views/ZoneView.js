define(["underscore","app/time","app/viewport","app/user","app/controller","app/core/View","./SetupView","app/horti-dashboard/templates/zone"],function(t,e,s,i,o,a,r,n){"use strict";return a.extend({template:n,nlsDomain:"horti-dashboard",events:{"click #-action":function(){this.act(!1)}},initialize:function(){this.tags={},["status","testId","program","serialNumbers","startTime","finishTime","greenLed","orangeLed","redLed","buzzer","on"].forEach(t=>{this.tags[t]=o.tags.get(`zones.${this.options.zoneNo}.${t}`)}),["greenLed","orangeLed","redLed"].forEach(t=>{this.listenTo(this.tags[t],"change:value",()=>{this.updateLeds()})}),this.listenTo(this.tags.status,"change:value",()=>{this.updateText(),this.updateProgress(),this.updateAction()}),this.listenTo(this.tags.program,"change:value",()=>{this.updateText()}),this.listenTo(this.tags.testId,"change:value",()=>{this.updateText()}),this.listenTo(this.tags.startTime,"change:value",()=>{this.updateProgress()}),this.listenTo(this.tags.finishTime,"change:value",()=>{this.updateProgress()}),this.listenTo(o.tags,"reset",this.render)},getTemplateData:function(){return{zoneNo:this.options.zoneNo}},afterRender:function(){this.updateText(),this.updateLeds(),this.updateProgress(),this.updateAction()},updateText:function(){const e=this.tags.program.get("value"),s=this.tags.testId.get("value");let i=this.t(`status:${this.tags.status.get("value")}`);s&&(i=`<a href="#horti/tests/${s}">${i}</a>`),e&&e.name&&(i+=`: ${t.escape(e.name)}`),this.$id("text").html(i)},updateLeds:function(){let t="gray";this.tags.greenLed.get("value")?t="green":this.tags.orangeLed.get("value")?t="orange":this.tags.redLed.get("value")&&(t="red"),this.$id("led")[0].dataset.color=t},updateProgress:function(){clearTimeout(this.timers.updateProgress);const t=this.tags.status.get("value");let s="progress-bar-warning",i=0,o=0;if("running"===t){const t=this.tags.startTime.get("value"),a=this.tags.finishTime.get("value"),r=e.getServerMoment().valueOf();i=(a-r)/1e3,o=(r-t)/(a-t)*100,this.tags.on.get("value")||(s="progress-bar-info"),this.timers.updateProgress=setTimeout(this.updateProgress.bind(this),1e3)}else if("success"===t||"failure"===t){const e=this.tags.startTime.get("value");i=(this.tags.finishTime.get("value")-e)/1e3,o=100,s="success"===t?"progress-bar-success":"progress-bar-danger"}this.$id("bar").removeClass("progress-bar-warning progress-bar-info progress-bar-danger progress-bar-success").addClass(s).css("width",`${o}%`),this.$id("remaining").text(i?e.toString(i,!0,!1):"")},updateAction:function(){const t=this.tags.status.get("value");let e="btn-warning",s="start";"running"===t?(e="btn-danger",s="stop"):"success"!==t&&"failure"!==t||(e="btn-primary",s="reset"),this.$id("action").removeClass("btn-primary btn-warning btn-danger").addClass(e).text(this.t(`action:${s}`)).prop("disabled",!i.isAllowedTo("LOCAL","HORTI:MANAGE"))},showSetupDialog:function(t){const{zoneNo:e}=this.options,i=new r({zoneNo:e});s.showDialog(i,this.t("setup:title",{zoneNo:e})),t&&this.broker.publish("horti.message",{type:"success",time:3e3,text:this.t("msg:setupSuccess",{zoneNo:e})})},act:function(t){const e=this.tags.status.get("value");"idle"===e||"setup"===e?this.setup(t):"running"===e?this.stop(t):this.reset(t)},setup:function(t){const{zoneNo:e}=this.options;if("setup"===this.tags.status.get("value"))return this.showSetupDialog(t);o.tags.setValue(`zones.${e}.status`,"setup",i=>{i?(console.error(`Failed to setup zone ${e}:`,i),t?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:setupFailure",{zoneNo:e})}):s.msg.show({type:"error",time:3e3,text:this.t("msg:setupFailure",{zoneNo:e})})):this.showSetupDialog(t)})},stop:function(t){const{zoneNo:e}=this.options;this.$id("action").prop("disabled",!0),o.tags.setValue(`zones.${e}.status`,"failure",i=>{i?(console.error(`Failed to stop zone ${e}:`,i),t?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:stopFailure",{zoneNo:e})}):s.msg.show({type:"error",time:3e3,text:this.t("msg:stopFailure",{zoneNo:e})}),this.$id("action").prop("disabled",!1)):t&&this.broker.publish("horti.message",{type:"success",time:6e3,text:this.t("msg:stopSuccess",{zoneNo:e})})})},reset:function(t){const{zoneNo:e}=this.options;this.$id("action").prop("disabled",!0),o.tags.setValue(`zones.${e}.status`,"idle",i=>{i?(console.error(`Failed to stop zone ${e}:`,i),t?this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:resetFailure",{zoneNo:e})}):s.msg.show({type:"error",time:3e3,text:this.t("msg:resetFailure",{zoneNo:e})}),this.$id("action").prop("disabled",!1)):t&&this.broker.publish("horti.message",{type:"success",time:6e3,text:this.t("msg:resetSuccess",{zoneNo:e})})})},handleAction:function(t){if("MAIN"===t)return this.act(!0);const e=this.tags.status.get("value");return"START"!==t||"idle"!==e&&"setup"!==e?"STOP"===t&&"running"===e?this.stop(!0):"RESET"!==t||"setup"!==e&&"success"!==e&&"failure"!==e?void this.broker.publish("horti.message",{type:"error",time:6e3,text:this.t("msg:invalidAction",{action:t})}):this.reset(!0):this.setup(!0)}})});