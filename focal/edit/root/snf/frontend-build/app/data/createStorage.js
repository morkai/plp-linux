// Part of <https://miracle.systems/p/walkner-snf> licensed under <CC BY-NC-SA 4.0>

define(["app/time","app/broker","app/pubsub"],function(e,t,n){"use strict";return function(o,a,d){function i(){localStorage.setItem(o,JSON.stringify({time:Date.now(),data:l.models})),t.publish(a+".synced")}var r=window[o]||[],s=JSON.parse(localStorage.getItem(o)||"null");s&&!navigator.onLine||(s={time:e.appData,data:r},localStorage.setItem(o,JSON.stringify(s)));var c=s.time>r.time?s:r,l=new d(c);return l.on("add",i),l.on("remove",i),l.on("destroy",i),l.on("change",i),l.on("sync",i),n.subscribe(a+".added",function(e){l.add(e.model)}),n.subscribe(a+".edited",function(e){var t=l.get(e.model._id);t?t.set(e.model):l.add(e.model)}),n.subscribe(a+".deleted",function(e){l.remove(e.model._id)}),l}});