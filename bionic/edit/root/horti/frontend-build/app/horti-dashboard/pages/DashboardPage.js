define(["jquery","app/user","app/viewport","app/controller","app/core/View","../views/ZoneView","../views/SetupView","app/horti-dashboard/templates/page"],function(e,t,i,n,s,o,r,a){"use strict";return s.extend({template:a,layoutName:"page",nlsDomain:"horti-dashboard",pageId:"horti-dashboard",actions:[],events:{"click #-message":function(){this.hideMessage()}},localTopics:{"horti.message":function(e){this.showMessage(e)}},initialize:function(){this.keyBuffer="",this.once("afterRender",()=>{this.listenTo(n.tags.get("zoneCount"),"change:value",this.renderZones),e(window).on(`keypress.${this.idPrefix}`,this.onWindowKeyPress.bind(this)),e(window).on(`keydown.${this.idPrefix}`,this.onWindowKeyDown.bind(this))})},destroy:function(){e(window).off(`.${this.idPrefix}`)},getTemplateData:function(){return{}},load:function(e){return e(n.load())},afterRender:function(){this.renderZones()},renderZones:function(){this.removeView("#-zones"),this.zoneViews={};const e=n.tags.getValue("zoneCount");for(let t=1;t<=e;++t)this.zoneViews[t]=new o({zoneNo:t}),this.insertView("#-zones",this.zoneViews[t]),this.zoneViews[t].render()},onWindowKeyPress:function(e){e.keyCode>=32&&e.keyCode<=126&&(this.keyBuffer+=String.fromCharCode(e.keyCode).toUpperCase()),clearTimeout(this.timers.handleKeyBuffer),this.timers.handleKeyBuffer=setTimeout(this.handleKeyBuffer.bind(this),150)},onWindowKeyDown:function(e){if("Enter"===e.key&&this.keyBuffer.length>5)return!1},handleKeyBuffer:function(e){e||(e=this.keyBuffer),this.keyBuffer="";const t=e.match(/([A-Z0-9]{4}\.[0-9]{9}\.[0-9]{4})/);if(t)this.handleSerialNumber(t[1]);else{const t=e.match(/^HORTI ([0-9]+)(?: ([A-Z]+))?$/);t&&this.handleZoneAction(+t[1],t[2]||"MAIN")}},handleSerialNumber:function(e){i.currentDialog instanceof r?i.currentDialog.handleSerialNumber(e):this.showMessage({type:"error",time:1e4,text:this.t("msg:setupRequired")})},handleZoneAction:function(e,t){if(i.currentDialog instanceof r&&i.currentDialog.options.zoneNo===e)return i.currentDialog.handleAction(t);i.closeAllDialogs();const n=this.zoneViews[e];n||this.showMessage({type:"error",time:5e3,text:this.t("msg:invalidZone",{zoneNo:e})}),n.handleAction(t)},showMessage:function(e){clearTimeout(this.timers.hideMessage);const t=this.$id("message");t[0].dataset.type=e.type||"info",t.find(".horti-message-text").html(e.text),t.removeClass("hidden"),e.time&&(this.timers.hideMessage=setTimeout(this.hideMessage.bind(this),e.time))},hideMessage:function(){this.$id("message").addClass("hidden")}})});