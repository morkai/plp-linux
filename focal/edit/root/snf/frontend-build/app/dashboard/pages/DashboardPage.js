// Part of <https://miracle.systems/p/walkner-snf> licensed under <CC BY-NC-SA 4.0>

define(["jquery","app/i18n","app/user","app/viewport","app/data/programs","app/core/View","app/core/Model","app/snf-tests/views/TestListView","app/snf-tests/TestCollection","../views/AssignProgramsView","../views/PrintHidLabelView","../views/CameraView","../views/CurrentProgramView","../views/CurrentStateView","../views/ImageGalleryView","../Dashboard","app/snf-tests/Test","app/dashboard/templates/dashboard"],function(e,t,i,s,a,n,l,o,r,h,g,c,d,m,w,u,p,f){"use strict";return n.extend({template:f,layoutName:"page",remoteTopics:{"snf.tests.started":function(e){this.model.set("currentTest",e?new p(e):null),this.model.update()},"snf.tests.finished":function(e){this.model.set({currentTest:null,lastTest:e?new p(e):null}),this.model.update()}},actions:function(){var e=[{className:"dashboard-action-gallery",label:this.t("gallery:pageAction"),icon:"image",callback:this.showImageGalleryDialog.bind(this)}];return(i.data.local||i.isAllowedTo("SNF:MANAGE"))&&e.push({label:this.t("assignPrograms:pageAction"),icon:"plus",callback:this.showAssignProgramsDialog.bind(this)},{label:this.t("printHidLabel:pageAction"),icon:"print",callback:this.showPrintHidLabelDialog.bind(this)}),e},initialize:function(){this.model=new u,this.tests=new r(null,{paginate:!1}),this.tests.rqlQuery.limit=10,this.currentProgramView=new d({model:this.model}),this.currentStateView=new m,this.testListView=new o({collection:this.tests,columns:[{id:"program"},{id:"orderNo",className:"is-min"},{id:"serialNo",className:"is-min is-number"},{id:"startedAt",className:"is-min"},{id:"duration",className:"is-min"}]}),this.setView("#-program",this.currentProgramView),this.setView("#-state",this.currentStateView),this.setView("#-tests",this.testListView),i.data.local&&(this.cameraView=new c,this.setView("#-camera",this.cameraView)),this.listenTo(a,"change:images",this.onImagesChanged),this.listenTo(this.model,"change:currentProgram",this.toggleGalleryAction)},getTemplateData:function(){return{local:!!i.data.local}},load:function(e){return e(this.model.fetch(),this.tests.fetch({reset:!0}))},afterRender:function(){this.toggleGalleryAction()},showAssignProgramsDialog:function(){var e=new h({model:{nlsDomain:this.model.nlsDomain}});s.showDialog(e,this.t("assignPrograms:dialogTitle"))},showPrintHidLabelDialog:function(){var e=new g({model:{nlsDomain:this.model.nlsDomain,lastTest:this.tests.find(function(e){return!!e.get("orderNo")&&e.get("serialNo")>0})}});s.showDialog(e,this.t("printHidLabel:dialogTitle"))},showImageGalleryDialog:function(){var e=this.model.get("currentProgram");e&&e.get("images").length&&s.showDialog(new w({model:e}))},onImagesChanged:function(e){var t=this.model.get("currentProgram");t&&e.id!==t.id||this.toggleGalleryAction()},toggleGalleryAction:function(){var t=this.model.get("currentProgram");e(".dashboard-action-gallery").attr("disabled",!t||!t.get("images").length)}})});